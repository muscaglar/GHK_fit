execute_fit <- function(saltName , concName , override_cat_an, input_data) {
  R = 8.3144621
  F_c = 96485.3399
  T = 296
  U = R*T/F_c
  
  switch(saltName , 
         KCl = {
           # if(strcmp(polarity , 'cation'))
           # {
           formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
           prefix = -1
           #}
           #else
           #{
           #formula = y ~ (0.0259)*log(((1/P) + x) / ((1/P)*x + 1))
           #prefix = 1
           #}
         } , 
         BKCl = {
           #if(strcmp(polarity , 'cation'))
           #{
           formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
           prefix = -1
           # }
           # else
           # {
           #   formula = y ~ (0.0259)*log(((1/P) + x) / ((1/P)*x + 1))
           #   prefix = 1
           #  }
         } , 
         LiCl = {
           #   if(strcmp(polarity , 'cation'))
             # {
             formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
             prefix = -1
             #  }
           #  else
             #   {
             #formula = y ~ (0.0259)*log(((1/P) + x) / ((1/P)*x + 1))
             #     prefix = 1
             #   }
         } , 
         HCl = {
              if(strcmp(override_cat_an , 'An'))
            {
                formula = y ~ (0.0259)*log(((1/P) + x) / ((1/P)*x + 1))
                prefix = 1
                
             }
             else
              {
               formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
               prefix = -1
              }
         } , 
         NaCl = {
           #   if(strcmp(polarity , 'cation'))
             #  {
             formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
             prefix = -1
             #    }
           #   else
             #   {
           #     formula = y ~ (0.0259)*log(((1/P) + x) / ((1/P)*x + 1))
             #     prefix = 1
             #   }
         } , 
         MgCl2 = {
           #if(strcmp(polarity , 'cation'))
             #{
             formula = y~(0.0259)*log((sqrt(8*x^2*(P) + x^2 + 16*x*(P)^2 + 2*x + 8*(P) + 1) + x - 1)/(2*(2*x*(P) + 1)))
             prefix = -2
             #}
           #else
           #{
           #  formula = y~(0.0259)*log((sqrt(8*x^2*((1/P)) + x^2 + 16*x*((1/P))^2 + 2*x + 8*((1/P)) + 1) + x - 1)/(2*(2*x*((1/P)) + 1)))
           #  prefix = 1
           #}
         } , 
         ALaCl3 = {
           if(strcmp(concName , "10mM"))
           {
             prefix = -3
             formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           }
           else
           {
             prefix = 1
             formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
           }
         } , 
         LaCl3 = {
           if(strcmp(concName , '1mM'))
           {
             prefix = -3
             formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           }
           else if(strcmp(concName, '10mM'))
           {
             if(strcmp(override_cat_an,'Ca'))
             {
               prefix = -3
               formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
               
             }
             else
             {
               prefix = 1
               formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
             }
           }
           else
           {
             prefix = 1
             formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
             
           }
         } , 
         CeCl3 = {
           if(strcmp(concName , '1mM'))
           {
             prefix = -3
             formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           }
           else if(strcmp(concName, '10mM'))
           {
             if(strcmp(override_cat_an,'Ca'))
             {
                prefix = -3
                formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
             }
               else
              {
                 prefix = 1
                 formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
              }
           }
           else
           {
             prefix = 1
             formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
             
           }
         } , 
         HfCl4 = {
           #  if(strcmp(polarity , 'cation'))
           # {
           #    prefix = -3
           #    formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           #   }
           #   else
           #   {
           prefix = 1
           formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
           #   }
         } , 
         ZrCl4 = {
           #if(strcmp(polarity , 'cation'))
           #{
           #  prefix = -3
           #   formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           # }
           # else
           # {
           prefix = 1
           formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
           # }
         } , 
         K3PO4 = {
           #  if(strcmp(polarity , 'cation'))
           #  {
           prefix = -1
           formula = y~ (0.0259)*log((7*x^3*(P)^3+81*x^3*(P)^2+15*x^2*(P)^3+27*x^2*(P)^2+486*x^2*(P)+((7*x^3*(P)^3+81*x^3*(P)^2+15*x^2*(P)^3+27*x^2*(P)^2+486*x^2*(P)+3*x*(P)^3+108*x*(P)^2+729*x+2*(P)^3+27*(P)^2+243*(P))^2+4*(3*(x-1)*(P)*(x*(P)+3)-(x-1)^2*(P)^2)^3)^(1/2)+3*x*(P)^3+108*x*(P)^2+729*x+2*(P)^3+27*(P)^2+243*(P))^(1/3)/(3*2^(1/3)*(x*(P)+3))-(2^(1/3)*(3*(x-1)*(P)*(x*(P)+3)-(x-1)^2*(P)^2))/(3*(x*(P)+3)*(7*x^3*(P)^3+81*x^3*(P)^2+15*x^2*(P)^3+27*x^2*(P)^2+486*x^2*(P)+((7*x^3*(P)^3+81*x^3*(P)^2+15*x^2*(P)^3+27*x^2*(P)^2+486*x^2*(P)+3*x*(P)^3+108*x*(P)^2+729*x+2*(P)^3+27*(P)^2+243*(P))^2+4*(3*(x-1)*(P)*(x*(P)+3)-(x-1)^2*(P)^2)^3)^(1/2)+3*x*(P)^3+108*x*(P)^2+729*x+2*(P)^3+27*(P)^2+243*(P))^(1/3))-((x-1)*(P))/(3*(x*(P)+3)))
           # }
           # else
           # {
           #prefix = 3
           #formula = y~ (0.0259)*log((7*x^3*((1/P))^3+81*x^3*((1/P))^2+15*x^2*((1/P))^3+27*x^2*((1/P))^2+486*x^2*((1/P))+((7*x^3*((1/P))^3+81*x^3*((1/P))^2+15*x^2*((1/P))^3+27*x^2*((1/P))^2+486*x^2*((1/P))+3*x*((1/P))^3+108*x*((1/P))^2+729*x+2*((1/P))^3+27*((1/P))^2+243*((1/P)))^2+4*(3*(x-1)*((1/P))*(x*((1/P))+3)-(x-1)^2*((1/P))^2)^3)^(1/2)+3*x*((1/P))^3+108*x*((1/P))^2+729*x+2*((1/P))^3+27*((1/P))^2+243*((1/P)))^(1/3)/(3*2^(1/3)*(x*((1/P))+3))-(2^(1/3)*(3*(x-1)*((1/P))*(x*((1/P))+3)-(x-1)^2*((1/P))^2))/(3*(x*((1/P))+3)*(7*x^3*((1/P))^3+81*x^3*((1/P))^2+15*x^2*((1/P))^3+27*x^2*((1/P))^2+486*x^2*((1/P))+((7*x^3*((1/P))^3+81*x^3*((1/P))^2+15*x^2*((1/P))^3+27*x^2*((1/P))^2+486*x^2*((1/P))+3*x*((1/P))^3+108*x*((1/P))^2+729*x+2*((1/P))^3+27*((1/P))^2+243*((1/P)))^2+4*(3*(x-1)*((1/P))*(x*((1/P))+3)-(x-1)^2*((1/P))^2)^3)^(1/2)+3*x*((1/P))^3+108*x*((1/P))^2+729*x+2*((1/P))^3+27*((1/P))^2+243*((1/P)))^(1/3))-((x-1)*((1/P)))/(3*(x*((1/P))+3)))
           #  }
         } ,
         KClHfCl4 = {
           if(strcmp(concName , '001mM'))
           {
             formula = y ~ (0.0259)*log((P + x) / (P*x + 1))
             prefix = -4
            }
          if(strcmp(concName , '01mM'))
          {
            prefix = 1
            pre = 0.2
            formula = y~ pre*((0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1))))+(1-pre)*((0.0259)*log((P + x) / (P*x + 1)))
          }
           if(strcmp(concName , '1mM'))
           {
             prefix = 1
             pre = 0.775
             formula = y~ pre*((0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1))))+(1-pre)*((0.0259)*log((P + x) / (P*x + 1)))
            }
         },
         KClLaCl3 = {
           if(strcmp(concName , '10mM'))
           {
             prefix = -3
             formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           }
           else if(strcmp(concName, '100mM'))
           {
             prefix = -3
             formula = y~(0.0259)*log((243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + (4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^2)^(1/2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P) + 7)^(1/3)/(3*2^(1/3)*(3*x*(P) + 1)) - (2^(1/3)*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2))/(3*(3*x*(P) + 1)*(243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + sqrt(4*(-9*x^2*(P) - x^2 + 9*x*(P) - x + 2)^3 + (243*x^3*(P)^2 + 27*x^3*(P) + 2*x^3 + 729*x^2*(P)^3 + 108*x^2*(P) + 3*x^2 + 486*x*(P)^2 + 27*x*(P) + 15*x+ 81*(P)+ 7)^2) + 486*x*(P)^2 + 27*x*(P) + 15*x + 81*(P)+ 7)^(1/3)) - (1 - x)/(3*(3*x*(P) + 1)))
           }
           else if(strcmp(concName, '1M'))
           {
             prefix = 1
             formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
           }
           else
           {
             prefix = 1
             formula = y~(0.0259)*log((243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + (4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^2)^(1/2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P)) + 7)^(1/3)/(3*2^(1/3)*(3*x*((1/P)) + 1)) - (2^(1/3)*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2))/(3*(3*x*((1/P)) + 1)*(243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + sqrt(4*(-9*x^2*((1/P)) - x^2 + 9*x*((1/P)) - x + 2)^3 + (243*x^3*((1/P))^2 + 27*x^3*((1/P)) + 2*x^3 + 729*x^2*((1/P))^3 + 108*x^2*((1/P)) + 3*x^2 + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x+ 81*((1/P))+ 7)^2) + 486*x*((1/P))^2 + 27*x*((1/P)) + 15*x + 81*((1/P))+ 7)^(1/3)) - (1 - x)/(3*(3*x*((1/P)) + 1)))
           }
         }
         )
  
  #### Setting up ideal X, Y parameters to obtain the starting P value
  x <- c(0.0001 , 0.001 , 0.01 , 0.1 , 1 , 10 , 100)
  x_ideal <- x
  y <- c(prefix*(R*T / F_c) * log(x))
  y_ideal <- y
  ideal <- nlsLM(formula,start=list(P=1),lower=c(P=0))
  ideal_P <- unname(coef(ideal))
  #########
  
  #### Fitting the model
  
  weight_vector = input_data$error
  weight_vector[ weight_vector==0 ] <- abs(input_data$y[weight_vector==0]*0.02)
  
  oModel <- nlsLM(formula , data=input_data ,weights=weight_vector, start=list(P=0.1),lower=c(P=0),upper=c(P=ideal_P))
  formula_expression <- unlist(strsplit(as.character(formula), "~")[[1]])[2]
  oModel_P <- unname(coef(oModel))
  deg_freedom <- df.residual(oModel)
  #######
  
  oModel_predict =predict(oModel,newdata=input_data$x,se.fit = TRUE)
  oModel_resid = oModel_predict-input_data$y
  oModel_resid_sum = sum(oModel_resid^2)
  oModel_se = sqrt((oModel_resid_sum/deg_freedom)*vcov(oModel))
  
  confint_output = tryCatch({
    unname(confint(oModel)[2])
  }, warning = function(w) {
     
  }, error = function(e) {
    confint_output = 0
  }, finally = {
  })
  
  ### Purely Cosmetic?
  #### Obtaining Y values for a range of X values using the calculated P and the respective formula
  x_expanded_data <- c(seq(from = 0.00001, to = 0.01, by = 0.00001),seq(from = 0.011, to = 0.1, by = 0.0001),seq(from = 0.11, to = 1, by = 0.01),seq(from = 1.01, to = 10, by = 0.1),seq(from = 10.01, to = 100, by = 1),seq(from = 100.01, to = 3000, by = 100))
  P <- oModel_P
  ind <- 1
  y_expanded_data <- 0
  for(x in x_expanded_data){
    y_expanded_data[ind] <- eval(parse(text=formula_expression))
    ind <- ind +1
  }
  #######
  
  nameAdd <- paste(concName,".csv",sep="")
  saveNameAdd <- ("/Volumes/MusDrive/Dropbox/data/ZGHK_fit_")
  saveName <- paste(saveNameAdd,nameAdd,sep="")
  GHK_model_fit <- cbind(x_expanded_data,y_expanded_data)
  write.csv(GHK_model_fit,saveName)
  
  plot(x_expanded_data,y_expanded_data,log='x',type="l",col="red")
  points(input_data$x,input_data$y, log='x',col="green")
  #points(x_ideal,y_ideal,log='x',col="pink")
  
  oModel_sum <- c(coef(summary(oModel)))
  oModel_resids <- c(nlsResiduals(oModel))
  
  resi1 <-  oModel_resids$resi1
  resi2 <-  oModel_resids$resi2
  resi3 <-  oModel_resids$resi3
  resi4 <-  oModel_resids$resi4
  std95 <-  oModel_resids$std95
  
  oModel_summary <- list("975" = confint_output,"se"=oModel_se, "summary" = oModel_sum, "resi1" = resi1,"resi2" = resi2,"resi3" = resi3,"resi4" = resi4,"std95" = std95,"sse_error" = oModel_se)
  
  return(oModel_summary)
}

#install.packages("nlstools")
#install.packages("pracma")
#install.packages("minpack.lm")
#install.packages("foreach")
#install.packages("formula.tools")

library(minpack.lm)
library(pracma)
library(nlstools)
library(foreach)
library(formula.tools)
library(minpack.lm)
library(metafor)
library(MASS)

#Input File Handling
master_dir <- "/Volumes/MusDrive/Dropbox/data/"
csv_files <- dir(path = master_dir, include.dirs = FALSE, pattern = ".csv")

for (fName in csv_files )
{
  salt_conc <- unlist(strsplit(as.character(fName), "GHK_"))[[2]]
  salt_conc <- unlist(strsplit(as.character(salt_conc), ".csv"))[[1]]
  salt_conc <- unlist(strsplit(as.character(salt_conc), "_"))
  
  if(length(salt_conc)>2)
  {
    salt <- salt_conc[1]
    conc <- salt_conc[2]
    trigger <- salt_conc[3]
  }
  else
  {
    salt <- salt_conc[1]
    conc <- salt_conc[2]
    trigger <- "NaN"
  }
  
  my.data <- read.csv(file=paste(master_dir,fName,sep="") ,  header=TRUE ,  sep=",")
  o.Model_summary <- execute_fit(salt , conc ,trigger, my.data)
  saveName <- paste(master_dir,"Z",sep="")
  saveName <- paste(saveName,fName,sep="")
  summarySaveName <- paste(master_dir,"Z.csv",sep="")
  summary <- list(salt,conc,o.Model_summary$summary[[1]],unname(o.Model_summary[[2]]))#o.Model_summary$summary[[2]])

   capture.output(o.Model_summary, file=saveName)
  
  #STD95 error is not changing, SSE error is failing on 2nd or 3rd run with a large P value.
  
   write.table( summary , file=summarySaveName , append = T , sep=',' ,   row.names=F , col.names=F)
}
